# ============================================================================
# Music Albums API - Azure DevOps Pipeline
# ============================================================================
#
# PREREQUISITES (one-time manual setup - see README.md for details):
#   1. Resource Group: music-albums
#   2. Key Vault: music-albums-kv (with 4 INPUT secrets)
#   3. Variable Group: music-albums-keyvault (linked to Key Vault on Azure DevOps)
#   4. Service Connection: azure-service-connection
#
# PIPELINE VARIABLES (Azure DevOps UI):
#   - RESOURCE_GROUP, DeployInfra
#
# SECRETS (from Key Vault via Variable Group):
#   - pg-admin-login, pg-admin-password, jwt-key, api-key
#
# ============================================================================

trigger:
  branches:
    include:
      - main
  paths:
    include:
      - src/**
      - Dockerfile
      - infra/**

pr:
  branches:
    include:
      - main
  paths:
    include:
      - src/**
      - Dockerfile
      - infra/**

pool:
  vmImage: ubuntu-latest

variables:
  - group: music-albums-keyvault
  - name: imageRepository
    value: fernandotonacoder/music-albums-api
  - name: containerRegistry
    value: github-ghcr
  - name: dockerfilePath
    value: '$(Build.SourcesDirectory)/Dockerfile'
  - name: tag
    value: '$(Build.BuildId)'

stages:
  # ============================================================================
  # Build Stage
  # ============================================================================
  - stage: Build
    displayName: Build and Push
    jobs:
      - job: Build
        displayName: Build Docker Image
        variables:
          DOCKER_BUILDKIT: 1
        steps:
          - task: Docker@2
            displayName: Build Docker image
            inputs:
              containerRegistry: $(containerRegistry)
              repository: '$(imageRepository)'
              command: build
              Dockerfile: '$(dockerfilePath)'
              arguments: '--label "org.opencontainers.image.source=https://github.com/fernandotonacoder/music-albums-api"'
              tags: |
                $(tag)
                latest

          - task: Docker@2
            displayName: Push to GitHub Container Registry
            inputs:
              containerRegistry: $(containerRegistry)
              repository: '$(imageRepository)'
              command: push
              tags: |
                $(tag)
                latest

  # # ============================================================================
  # # Test Stage
  # # ============================================================================
  # - stage: Test
  #   displayName: 'Run Tests'
  #   dependsOn: Build
  #   jobs:
  #     - job: UnitTests
  #       displayName: 'Unit Tests'
  #       steps:
  #         - task: UseDotNet@2
  #           displayName: 'Use .NET SDK'
  #           inputs:
  #             packageType: 'sdk'
  #             version: '8.x'

  #         - task: DotNetCoreCLI@2
  #           displayName: 'Restore packages'
  #           inputs:
  #             command: 'restore'
  #             projects: '**/*.csproj'

  #         - task: DotNetCoreCLI@2
  #           displayName: 'Run unit tests'
  #           inputs:
  #             command: 'test'
  #             projects: '**/tests/**/*.csproj'
  #             arguments: '--configuration Release --no-restore'

  # ============================================================================
  # Deploy Infrastructure Stage (optional - run manually or on infra changes)
  # ============================================================================
  - stage: DeployInfra
    displayName: Deploy Infrastructure
    dependsOn: Build
    condition: and(succeeded(), eq(variables['DeployInfra'], 'true'))
    jobs:
      - job: DeployBicep
        displayName: Deploy Bicep Template
        steps:
          - task: AzureCLI@2
            displayName: Deploy infrastructure
            inputs:
              azureSubscription: azure-service-connection
              scriptType: bash
              scriptLocation: inlineScript
              inlineScript: |
                az deployment group create \
                  --resource-group '$(RESOURCE_GROUP)' \
                  --template-file infra/main.bicep \
                  --parameters \
                    postgresAdminLogin='$(pg-admin-login)' \
                    postgresAdminPassword='$(pg-admin-password)' \
                    jwtKey='$(jwt-key)' \
                    apiKey='$(api-key)' \
                    imageTag='$(tag)'

  # ============================================================================
  # Deploy Application Stage
  # ============================================================================
  - stage: DeployApp
    displayName: Deploy Application
    dependsOn:
      - Build
      - DeployInfra
    condition: |
      and(
        not(failed('Build')),
        not(failed('DeployInfra')),
        ne(variables['Build.Reason'], 'PullRequest')
      )
    jobs:
      - deployment: DeployToAzure
        displayName: Deploy to Container Apps
        environment: production
        strategy:
          runOnce:
            deploy:
              steps:
                - checkout: self

                - task: AzureCLI@2
                  displayName: Update Container App
                  inputs:
                    azureSubscription: azure-service-connection
                    scriptType: bash
                    scriptLocation: inlineScript
                    inlineScript: |
                      az containerapp update \
                        --name 'music-albums-api' \
                        --resource-group '$(RESOURCE_GROUP)' \
                        --image 'ghcr.io/$(imageRepository):$(tag)'

                - task: AzureCLI@2
                  displayName: Verify deployment
                  inputs:
                    azureSubscription: azure-service-connection
                    scriptType: bash
                    scriptLocation: inlineScript
                    inlineScript: |
                      # Wait for deployment to stabilize
                      sleep 30

                      # Get the app URL and check health
                      APP_URL=$(az containerapp show \
                        --name 'music-albums-api' \
                        --resource-group '$(RESOURCE_GROUP)' \
                        --query 'properties.configuration.ingress.fqdn' -o tsv)

                      echo "Checking health at https://$APP_URL/_health"
                      curl -f "https://$APP_URL/_health" || exit 1
                      echo 'Deployment successful!'
