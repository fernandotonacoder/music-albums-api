# ============================================================================
# Music Albums API - Azure DevOps Pipeline
# ============================================================================
# This pipeline builds and deploys the Music Albums API to Azure Container Apps
# 
# Required Variables (set in Azure DevOps Pipeline Variables or Variable Groups):
# - ACR_NAME: Azure Container Registry name
# - AZURE_SUBSCRIPTION: Azure subscription ID
# - RESOURCE_GROUP: Azure resource group name
# - PG_ADMIN_LOGIN: PostgreSQL admin username
# - PG_ADMIN_PASSWORD: PostgreSQL admin password (secret)
# - JWT_KEY: JWT signing key (secret)
# - API_KEY: Admin API key (secret)
# ============================================================================

trigger:
  branches:
    include:
      - main
  paths:
    include:
      - src/**
      - Dockerfile
      - infra/**

pr:
  branches:
    include:
      - main
  paths:
    include:
      - src/**
      - Dockerfile
      - infra/**

pool:
  vmImage: 'ubuntu-latest'

variables:
  imageRepository: 'music-albums-api'
  dockerfilePath: '$(Build.SourcesDirectory)/Dockerfile'
  tag: '$(Build.BuildId)'

stages:
  # ============================================================================
  # Build Stage
  # ============================================================================
  - stage: Build
    displayName: 'Build and Push'
    jobs:
      - job: Build
        displayName: 'Build Docker Image'
        steps:
          - task: Docker@2
            displayName: 'Build and push to ACR'
            inputs:
              containerRegistry: 'acr-service-connection'
              repository: '$(imageRepository)'
              command: 'buildAndPush'
              Dockerfile: '$(dockerfilePath)'
              tags: |
                $(tag)
                latest

  # # ============================================================================
  # # Test Stage
  # # ============================================================================
  # - stage: Test
  #   displayName: 'Run Tests'
  #   dependsOn: Build
  #   jobs:
  #     - job: UnitTests
  #       displayName: 'Unit Tests'
  #       steps:
  #         - task: UseDotNet@2
  #           displayName: 'Use .NET SDK'
  #           inputs:
  #             packageType: 'sdk'
  #             version: '8.x'

  #         - task: DotNetCoreCLI@2
  #           displayName: 'Restore packages'
  #           inputs:
  #             command: 'restore'
  #             projects: '**/*.csproj'

  #         - task: DotNetCoreCLI@2
  #           displayName: 'Run unit tests'
  #           inputs:
  #             command: 'test'
  #             projects: '**/tests/**/*.csproj'
  #             arguments: '--configuration Release --no-restore'

  # ============================================================================
  # Deploy Infrastructure Stage (optional - run manually or on infra changes)
  # ============================================================================
  - stage: DeployInfra
    displayName: 'Deploy Infrastructure'
    dependsOn: Build  # TODO: Change to Test when tests are implemented
    condition: and(succeeded(), eq(variables['DeployInfra'], 'true'))
    jobs:
      - job: DeployBicep
        displayName: 'Deploy Bicep Template'
        steps:
          - task: AzureCLI@2
            displayName: 'Deploy infrastructure'
            inputs:
              azureSubscription: 'azure-service-connection'
              scriptType: 'bash'
              scriptLocation: 'inlineScript'
              inlineScript: |
                az deployment group create \
                  --resource-group $(RESOURCE_GROUP) \
                  --template-file infra/main.bicep \
                  --parameters \
                    acrName=$(ACR_NAME) \
                    postgresAdminLogin=$(PG_ADMIN_LOGIN) \
                    postgresAdminPassword=$(PG_ADMIN_PASSWORD) \
                    jwtKey=$(JWT_KEY) \
                    apiKey=$(API_KEY) \
                    imageTag=$(tag)

  # ============================================================================
  # Deploy Application Stage
  # ============================================================================
  - stage: DeployApp
    displayName: 'Deploy Application'
    dependsOn: Build  # TODO: Change to Test when tests are implemented
    condition: succeeded()
    jobs:
      - deployment: DeployToAzure
        displayName: 'Deploy to Container Apps'
        environment: 'production'
        strategy:
          runOnce:
            deploy:
              steps:
                - checkout: self

                - task: AzureCLI@2
                  displayName: 'Update Container App'
                  inputs:
                    azureSubscription: 'azure-service-connection'
                    scriptType: 'bash'
                    scriptLocation: 'inlineScript'
                    inlineScript: |
                      az containerapp update \
                        --name music-albums-api \
                        --resource-group $(RESOURCE_GROUP) \
                        --image $(ACR_NAME).azurecr.io/$(imageRepository):$(tag)

                - task: AzureCLI@2
                  displayName: 'Verify deployment'
                  inputs:
                    azureSubscription: 'azure-service-connection'
                    scriptType: 'bash'
                    scriptLocation: 'inlineScript'
                    inlineScript: |
                      # Wait for deployment to stabilize
                      sleep 30
                      
                      # Get the app URL and check health
                      APP_URL=$(az containerapp show \
                        --name music-albums-api \
                        --resource-group $(RESOURCE_GROUP) \
                        --query "properties.configuration.ingress.fqdn" -o tsv)
                      
                      echo "Checking health at https://$APP_URL/_health"
                      curl -f "https://$APP_URL/_health" || exit 1
                      echo "Deployment successful!"
